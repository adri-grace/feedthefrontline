{% extends 'base.html' %}
{% block content %}

<h1>Donate.</h1>
<p class="lead">Let's find a participating restaurant in your area.</p>
<div class="row">
    <div class="col s6">
        {% for restaurant in restaurants %}
        <a href="{% url 'rest_profile' restaurant.id %}">
            <div class="card">
                <div
                    id="r{{ restaurant.id }}"
                    data-name="{{ restaurant.restaurantName }}"
                    data-lat="{{ restaurant.lat }}"
                    data-lng="{{ restaurant.lng }}"
                ></div>
                <div class="card-content">
                    <span class="card-title">{{ restaurant.restaurantName }}</span>
                    <ul>
                        {% for facility in facilities %}
                            {% if facility.restaurant.id == restaurant.id %}
                            <li>{{ facility.facilityName }}</li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </a>
        {% endfor %}
    </div>
    <div class="col s6">
        <div id ="map"></div>
    </div>
    <form action="" method="post">
        {% csrf_token %}
        <input type="text" name="places-search">
        <input type="submit" value="Submit">
    </form>    
</div>
<div 
    id="counts"
    data-rest-count="{{ rest_max }}"
    data-fac-count="{{ fac_max }}"
></div>
{% for facility in facilities %}
<div
    id="f{{ facility.id }}"
    data-name="{{ facility.facilityName }}"
    data-lat="{{ facility.lat }}"
    data-lng="{{ facility.lng }}"
></div>
{% endfor %}
<script>
    let map, infoWindow, marker;
    let restLib = [];
    let facLib = [];
    let restMax = document.getElementById('counts').getAttribute('data-rest-count');
    let facMax = document.getElementById('counts').getAttribute('data-rest-count');
    
    function buildMarkerLibrary(lib, prefix, max){
        for(let i = 1; i <= max; i++){
            let getEl = document.getElementById(`${prefix}${i}`);
            if(getEl){
                let place = {
                name: getEl.getAttribute('data-name'),
                pos: {
                        lat: getEl.getAttribute('data-lat'),
                        lng: getEl.getAttribute('data-lng')
                    }
                }
            lib.push(place);    
            }
        }
    }

    buildMarkerLibrary(restLib, "r", restMax);
    buildMarkerLibrary(facLib, "f", facMax)
    console.log(restLib);
    console.log(facLib);


    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: 59.325, lng: 18.070},
        zoom: 13
        });

        // Try HTML5 geolocation.
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                let pos = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                marker = new google.maps.Marker({
                    map: map,
                    draggable: true,
                    animation: google.maps.Animation.DROP,
                    position: pos
                });
                map.setCenter(pos);
                map.setZoom(14);
                marker.addListener('click', toggleBounce);

        }, function() {
            handleLocationError(true, infoWindow, map.getCenter());
        });
        } else {
        // Browser doesn't support Geolocation
        handleLocationError(false, infoWindow, map.getCenter());
        }
    }
    // function setMarkers(map){
    //     for (let i = 0; i < restMarkers.length; i++) {
    //         let restMarker = restMarkers[i];
    //         let marker = new google.maps.Marker({

    //         })
    //     }
    // }
    
    function toggleBounce() {
        if (marker.getAnimation() !== null) {
            marker.setAnimation(null);
        } else {
            marker.setAnimation(google.maps.Animation.BOUNCE);
        }
        }
    function handleLocationError(browserHasGeolocation, infoWindow, pos) {
        infoWindow.setPosition(pos);
        infoWindow.setContent(browserHasGeolocation ?
                            'Error: The Geolocation service failed.' :
                            'Error: Your browser doesn\'t support geolocation.');
        infoWindow.open(map);
    }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCSoVHw83uV_E-uSqxMW7nTxuT4OQCL2m4&callback=initMap"></script>

{% endblock %}
